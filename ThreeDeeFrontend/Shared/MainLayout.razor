@inherits LayoutComponentBase
@using Color = MudBlazor.Color
@using ThreeDeeFrontend.ViewModels
@using ThreeDeeFrontend.Components
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.AspNetCore.Components
@using ThreeDeeFrontend.Services
@using ThreeDeeInfrastructure.Services

<PageTitle>@Localization.SharedMainPageTitle</PageTitle>
<MudThemeProvider 
    IsDarkMode="@ThemeProviderService.IsDarkMode"
    IsDarkModeChanged="async x => await SwitchTheme(x)" 
    Theme="_theme"/>
<MudDialogProvider/>
<MudSnackbarProvider/>
<MudLayout>
    <MudAppBar Elevation="1" Style="@($"background: {MenuBarBackgroundColor()};")">
        <a href="/">
            <img src="assets/logo3d.png" style="height: 48px;"/>
        </a>
        <div class="d-flex justify-center flex-grow-1 gap-4">
            <MudButton Variant="Variant.Filled">Files</MudButton>
            <MudButton Variant="Variant.Filled">Contribute</MudButton>
            <MudButton Variant="Variant.Filled">Services</MudButton>
            <MudButton Variant="Variant.Filled">Contact</MudButton>
        </div>
        <div style="padding-right: 50px; display: flex; align-items: center; align-content: center;">
            @if (_isAuthenticated)
            {
                <FileUpload UploadStateHasChanged="i => { _uploaded = i; }" />
            }
            <LoginDisplay/>
        </div>
        <MudSwitch
            @bind-Checked="@ThemeProviderService.IsDarkMode"
            Color="Color.Primary" T="bool"
            Label="@(ThemeProviderService.IsDarkMode ? Localization.SharedMainDarkModeDark : Localization.SharedMainDarkModeLight)"/>
    </MudAppBar>
    @if (_uploaded != 0)
    {
        <MudProgressLinear Style="top: 36px; height: 6px;" Color="Color.Secondary" Value="@_uploaded" Class="my-7" />
    }
    <MudMainContent Style="height: 100vh;">
        @Body
    </MudMainContent>
</MudLayout>

@code
{
    [Inject]
    public IThemeProviderService ThemeProviderService { get; set; }
    
    [Inject]
    public AuthenticationValidator AuthenticationValidator { get; set; }
    
    [Inject] 
    public ProtectedLocalStorage BrowserSettings { get; set; }
    
    private readonly MudTheme _theme = new();
    private const string SaveSettingsKey = "threedeedarkmodesetting";
    private bool _isAuthenticated;
    private int _uploaded = 0;


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _isAuthenticated = await AuthenticationValidator.GetAuthenticationState();
            try
            {
                var result = await BrowserSettings.GetAsync<bool>(SaveSettingsKey);
                if (result.Success)
                {
                    ThemeProviderService.IsDarkMode = result.Value;
                }
                else
                {
                    await BrowserSettings.SetAsync(SaveSettingsKey, ThemeProviderService.IsDarkMode);
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e);
            }
            StateHasChanged();
        }
    }

    private async Task SwitchTheme(bool isDarkTheme)
    {
        ThemeProviderService.IsDarkMode = isDarkTheme;
        try
        {
            await BrowserSettings.SetAsync(SaveSettingsKey, isDarkTheme);
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
        }
    }

    private string MenuBarBackgroundColor()
    {
        bool isDarkMode = ThemeProviderService.IsDarkMode;
        return _isAuthenticated switch
        {
            true when isDarkMode => "#3F51B5",
            true when isDarkMode == false => "#C5CAE9",
            _ => "transparent"
            };
    }
}


